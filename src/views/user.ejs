<!doctype html>
<html lang="en">
<head>
	<script type="importmap">
		{
			"imports": {
				"three": "https://cdn.jsdelivr.net/npm/three@0.182.0/build/three.module.js",
				"three/addons/": "https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/"
			}
		}
	</script>
	<meta charset="utf-8" />
	<title><%= user.display_name || user.email %> â€¢ Profile</title>
	<style>
		* { box-sizing: border-box; }

		body {
			margin: 0 auto;
			padding: 3rem;
			width: 80ch;
			max-width: 100%;
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
			color: rgba(255, 255, 255, 0.92);
			background: linear-gradient(180deg,#0b1020,#0a1226);
		}

		h1, h2 { margin-top: 0; }
		h1 { font-size: 3rem; margin-bottom: 1.2rem; }

		.card {
			background: rgba(255,255,255,.06);
			border: 0.1rem solid rgba(255,255,255,.10);
			border-radius: 1.1rem;
			box-shadow: 0 0.75rem 2.25rem rgba(0,0,0,.35);
			padding: 1.25rem;
			margin-bottom: 1rem;
		}

		.item-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
		.item {
			font: inherit;
			color: inherit;
			appearance: none;
			-webkit-appearance: none;
			border: 0.1rem solid rgba(255,255,255,.18);
			border-radius: 0.75rem;
			padding: 0.75rem;
			background: rgba(255,255,255,.08);
			min-width: 120px;
			text-align: center;
			cursor: pointer;
			transition: transform .08s, background .15s, opacity .15s;
		}
		.item.locked,
		.item:disabled {
			opacity: 0.35;
			cursor: not-allowed;
		}
		.item:hover:not(.locked):not(:disabled) { transform: translateY(-2px); background: rgba(0,229,255,.12); }
		.item:focus-visible { box-shadow: 0 0 0 0.2rem rgba(0, 229, 255, 0.45); }
		.avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 1rem; }
		button { cursor: pointer; }
		.back-link {
			display: inline-block;
			margin-bottom: 1rem;
			padding: 0.5rem 1rem;
			border-radius: 0.5rem;
			border: 0.1rem solid rgba(255,255,255,.2);
			background: rgba(255,255,255,.08);
			color: rgba(255,255,255,.92);
			text-decoration: none;
		}
		.back-link:hover { background: rgba(0,229,255,.12); }
		.goal-layout { display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap; }
		.goal-list { flex: 1 1 320px; }
		.goal-preview {
			flex: 0 0 180px;
			background: rgba(255,255,255,.05);
			border: 0.1rem solid rgba(255,255,255,.12);
			border-radius: 0.9rem;
			padding: 0.75rem;
		}
		.goal-preview-stage {
			position: relative;
			width: 100%;
			aspect-ratio: 1 / 1;
			border-radius: 0.8rem;
			border: 0.1rem solid rgba(255,255,255,.16);
			background: radial-gradient(circle at center, rgba(255,255,255,.16), rgba(255,255,255,.03) 65%);
			overflow: hidden;
		}
		.goal-preview-stage canvas {
			display: block;
			width: 100%;
			height: 100%;
		}
		.goal-preview-label {
			margin-top: 0.55rem;
			font-size: 0.9rem;
			color: rgba(255,255,255,.85);
		}
	</style>
</head>
<body>
	<a class="back-link" href="/">Back</a>
	<div class="card">
		<h1>Profile</h1>

		<% if (user.avatar_url) { %>
			<img src="<%= user.avatar_url %>" alt="Avatar" class="avatar" style="width: 100px; height: 100px; border-radius: 50%; margin-bottom: 1rem;">
		<% } %>

		<p>
			<strong>Name:</strong>
			<input
				type="text"
				id="display-name"
				value="<%= user.display_name || '' %>"
				placeholder="Enter display name"
				style="padding: 0.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: white; width: 200px;"
			/>
			<button id="update-display-name" style="padding: 0.5rem 1rem; border-radius: 0.5rem; margin-left: 0.5rem;">
				Update Name
			</button>
		</p>

		<p id="update-msg" style="color: lightgreen; margin-top: 0.5rem;"></p>

		<p><strong>Email:</strong> <%= user.email %></p>
	</div>

	<div class="card">
		<h2>Equipped Items</h2>
		<div class="item-list">
			<div class="item" id="equipped-paddle-skin" data-label="Paddle Skin">
				<strong>Paddle Skin:</strong><br>
				<%= equipped.paddle_skin_name || 'Default Paddle' %>
			</div>
			<div class="item" id="equipped-ball-skin" data-label="Ball Skin">
				<strong>Ball Skin:</strong><br>
				<%= equipped.ball_skin_name || 'Default Ball' %>
			</div>
			<div class="item" id="equipped-goal-explosion" data-label="Goal Explosion">
				<strong>Goal Explosion:</strong><br>
				<%= equipped.goal_explosion_name || 'Default Goal' %>
			</div>
		</div>
	</div>

	<div class="card">
		<h2>Paddle Skins</h2>
		<% if (paddleSkins.length > 0) { %>
			<div class="item-list" id="paddle-skins">
				<% paddleSkins.forEach(skin => { %>
					<button type="button" class="item <%= skin.unlocked_at ? '' : 'locked' %>" data-item-id="<%= skin.id %>" <%= skin.unlocked_at ? '' : 'disabled' %>>
						<strong><%= skin.display_name %></strong><br>
						<%= skin.unlocked_at ? 'âœ… Unlocked' : 'ðŸ”’ Locked' %>
					</button>
				<% }) %>
			</div>
		<% } else { %>
			<p>No paddle skins available.</p>
		<% } %>
	</div>

	<div class="card">
		<h2>Ball Skins</h2>
		<% if (ballSkins.length > 0) { %>
			<div class="item-list" id="ball-skins">
				<% ballSkins.forEach(skin => { %>
					<button type="button" class="item <%= skin.unlocked_at ? '' : 'locked' %>" data-item-id="<%= skin.id %>" <%= skin.unlocked_at ? '' : 'disabled' %>>
						<strong><%= skin.display_name %></strong><br>
						<%= skin.unlocked_at ? 'âœ… Unlocked' : 'ðŸ”’ Locked' %>
					</button>
				<% }) %>
			</div>
		<% } else { %>
			<p>No ball skins available.</p>
		<% } %>
	</div>

	<div class="card">
		<h2>Goal Explosions</h2>
		<div class="goal-layout">
			<div class="goal-list">
		<% if (goalExplosions.length > 0) { %>
			<div class="item-list" id="goal-explosions">
				<% goalExplosions.forEach(exp => { %>
					<button type="button" class="item <%= exp.unlocked_at ? '' : 'locked' %>" data-item-id="<%= exp.id %>" data-style-index="<%= exp.item_key %>" <%= exp.unlocked_at ? '' : 'disabled' %>>
						<strong><%= exp.display_name %></strong><br>
						<%= exp.unlocked_at ? 'âœ… Unlocked' : 'ðŸ”’ Locked' %>
					</button>
				<% }) %>
			</div>
		<% } else { %>
			<p>No goal explosions available.</p>
		<% } %>
			</div>
			<div class="goal-preview">
				<div class="goal-preview-stage" id="goal-preview-stage"></div>
				<div class="goal-preview-label" id="goal-preview-label">Select a goal explosion to preview</div>
			</div>
		</div>
	</div>

	<div style="margin-top:1rem; text-align:center; display: flex; gap: 0.5rem; justify-content: center;">
		<button id="debug-unlock-paddle" style="padding:0.5rem 1rem; border-radius:0.5rem;">
			Debug: Unlock Random Paddle Skin
		</button>
		<button id="debug-unlock-ball" style="padding:0.5rem 1rem; border-radius:0.5rem;">
			Debug: Unlock Random Ball Skin
		</button>
		<button id="debug-unlock-goal" style="padding:0.5rem 1rem; border-radius:0.5rem;">
			Debug: Unlock Random Goal Explosion
		</button>
	</div>

	<script>
		function equipItem(el, slot, displayEl) {
			el.addEventListener('click', () => {
				if (el.classList.contains('locked') || el.disabled) return;

				const itemId = el.dataset.itemId;
				const name = el.querySelector('strong').innerText;

				fetch('/user/items/equipItem', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'same-origin',
					body: JSON.stringify({ itemId, slot })
				})
				.then(res => res.json())
				.then(data => {
					if (data.ok) {
						displayEl.innerHTML = `<strong>${displayEl.dataset.label}:</strong><br>${name}`;
						const container = el.closest('.item-list');
						container.querySelectorAll('.item').forEach(i => i.style.borderColor = 'rgba(255,255,255,.18)');
						el.style.borderColor = 'rgb(0, 229, 255)';
					}
				});
			});
		}

		document.querySelectorAll('#paddle-skins .item').forEach(el => equipItem(el, 'paddle_skin', document.getElementById('equipped-paddle-skin')));
		document.querySelectorAll('#ball-skins .item').forEach(el => equipItem(el, 'ball_skin', document.getElementById('equipped-ball-skin')));
		document.querySelectorAll('#goal-explosions .item').forEach(el => equipItem(el, 'goal_explosion', document.getElementById('equipped-goal-explosion')));

		document.querySelectorAll('#goal-explosions .item').forEach(el => {
			el.addEventListener('click', () => {
				if (el.classList.contains('locked') || el.disabled) return;
				const name = el.querySelector('strong').innerText;
				window.triggerGoalPreview?.(name, el.dataset.styleIndex);
			});
		});

		document.getElementById('debug-unlock-ball')?.addEventListener('click', () => {
			fetch('/user/debug/unlockRandomBallSkin', {
				method: 'POST',
				credentials: 'same-origin'
			})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				window.location.reload();
			});
		});

		document.getElementById('debug-unlock-paddle')?.addEventListener('click', () => {
			fetch('/user/debug/unlockRandomPaddleSkin', {
				method: 'POST',
				credentials: 'same-origin'
			})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				window.location.reload();
			});
		});

		document.getElementById('debug-unlock-goal')?.addEventListener('click', () => {
			fetch('/user/debug/unlockRandomGoalExplosion', {
				method: 'POST',
				credentials: 'same-origin'
			})
			.then(res => res.json())
			.then(data => {
				alert(data.message);
				window.location.reload();
			});
		});

		const equippedPaddleSkinName = '<%= equipped.paddle_skin_name || "" %>';
		document.querySelectorAll('#paddle-skins .item').forEach(el => {
			if (el.querySelector('strong').innerText === equippedPaddleSkinName) {
				el.style.borderColor = 'rgb(0, 229, 255)';
			}
		});

		const equippedBallSkinName = '<%= equipped.ball_skin_name || "" %>';
		document.querySelectorAll('#ball-skins .item').forEach(el => {
			if (el.querySelector('strong').innerText === equippedBallSkinName) {
				el.style.borderColor = 'rgb(0, 229, 255)';
			}
		});

		const equippedGoalName = '<%= equipped.goal_explosion_name || "" %>';
		document.querySelectorAll('#goal-explosions .item').forEach(el => {
			if (el.querySelector('strong').innerText === equippedGoalName) {
				el.style.borderColor = 'rgb(0, 229, 255)';
				window.triggerGoalPreview?.(equippedGoalName, el.dataset.styleIndex);
			}
		});

		document.getElementById('update-display-name').addEventListener('click', async () => {
			const input = document.getElementById('display-name');
			const newName = input.value.trim();
			const msg = document.getElementById('update-msg');

			if (!newName) {
				msg.style.color = 'red';
				msg.textContent = 'Display name cannot be empty.';
				return;
			}

			try {
				const res = await fetch('/user/updateDisplayName', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ display_name: newName })
				});

				if (!res.ok) {
					const data = await res.json();
					throw new Error(data?.message || 'Failed to update display name.');
				}

				msg.style.color = 'lightgreen';
				msg.textContent = `Display name updated successfully to ${newName}!`;
			} catch (err) {
				msg.style.color = 'red';
				msg.textContent = err.message;
			}
		});
	</script>
	<script type="module">
		import * as THREE from 'three';
		import { GoalAnimationSpawner } from '/game/shaders/goalAnimationSpawner.js';

		const stage = document.getElementById('goal-preview-stage');
		const label = document.getElementById('goal-preview-label');
		if (stage && label) {
			const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
			renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
			stage.appendChild(renderer.domElement);

			const scene = new THREE.Scene();
			const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 100);
			camera.position.set(4.5, 2.1, 4.5);
			camera.lookAt(0, 0, 0);

			const ambient = new THREE.AmbientLight(0xffffff, 0.75);
			scene.add(ambient);
			const keyLight = new THREE.DirectionalLight(0xffffff, 0.9);
			keyLight.position.set(3, 4, 5);
			scene.add(keyLight);

			const previewSpawner = new GoalAnimationSpawner('profileGoalPreview');
			scene.add(previewSpawner.visual);

			const previewClock = new THREE.Clock();
			const burstPos = new THREE.Vector3(0, 0, 0);

			function resizePreview() {
				const width = stage.clientWidth || 180;
				const height = stage.clientHeight || width;
				renderer.setSize(width, height, false);
				camera.aspect = width / height;
				camera.updateProjectionMatrix();
			}

			function animatePreview() {
				requestAnimationFrame(animatePreview);
				const dt = Math.min(0.05, previewClock.getDelta());
				previewSpawner.update(dt);
				renderer.render(scene, camera);
			}

			window.triggerGoalPreview = (name, styleIndexRaw) => {
				const styleIndex = Number(styleIndexRaw);
				if (!Number.isFinite(styleIndex)) return;
				label.textContent = `Preview: ${name}`;
				burstPos.set(0, styleIndex === 3 ? -1.9 : 0, 0);
				previewSpawner.triggerGoalAnimation(styleIndex, null, burstPos);
			};

			resizePreview();
			animatePreview();
			window.addEventListener('resize', resizePreview);

			const selected = document.querySelector('#goal-explosions .item[style*="rgb(0, 229, 255)"]');
			const fallback = document.querySelector('#goal-explosions .item:not(.locked):not(:disabled)');
			const initial = selected || fallback;
			if (initial) {
				const name = initial.querySelector('strong')?.innerText || 'Goal Explosion';
				window.triggerGoalPreview(name, initial.dataset.styleIndex);
			}
		}
	</script>
</body>
</html>
