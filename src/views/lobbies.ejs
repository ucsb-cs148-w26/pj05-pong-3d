<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Lobbies â€¢ 3D Pong</title>
	</head>
	<body>
		<h1>Lobbies</h1>

		<input
			id="username-field"
			placeholder="Username"
			style="margin-bottom: 0.5rem"
		/>

		<div>
			<input id="name-field" placeholder="Lobby name" />
			<button id="create-button">Create Lobby</button>
		</div>

		<div>
			<input id="code-field" placeholder="Join Code" />
			<button id="join-button">Join</button>
		</div>

		<script>
			const authDiv = document.createElement('div');
			authDiv.style.marginTop = '1rem';

			const status = document.createElement('span');
			status.textContent = 'Checking login...';

			const loginButton = document.createElement('button');
			loginButton.textContent = 'Login with Google';
			loginButton.style.display = 'none';

			const logoutButton = document.createElement('button');
			logoutButton.textContent = 'Logout';
			logoutButton.style.display = 'none';

			loginButton.onclick = () => {
				window.location.href = '/auth/google';
			};

			logoutButton.onclick = async () => {
				await fetch('/auth/logout', { method: 'POST', credentials: 'same-origin' });
				checkAuth();
			};

			authDiv.appendChild(status);
			authDiv.appendChild(document.createTextNode(' '));
			authDiv.appendChild(loginButton);
			authDiv.appendChild(document.createTextNode(' '));
			authDiv.appendChild(logoutButton);
			document.body.appendChild(authDiv);

			async function checkAuth() {
				try {
					const res = await fetch('/auth/me', { credentials: 'same-origin' });
					if (!res.ok) {
						status.textContent = ' Not logged in';
						loginButton.style.display = '';
						logoutButton.style.display = 'none';
						return;
					}

					const { user } = await res.json();
					status.textContent = ` Logged in as ${user.displayName || 'User'}`;
					loginButton.style.display = 'none';
					logoutButton.style.display = '';
				} catch {
					status.textContent = ' Auth error';
					loginButton.style.display = '';
					logoutButton.style.display = 'none';
				}
			}

			checkAuth();

			const usernameField = document.getElementById('username-field');
			const nameField = document.getElementById('name-field');
			document
				.getElementById('create-button')
				.addEventListener('click', (e) => {
					if (!usernameField.value.length) return;

					fetch('/api/lobbies', {
						method: 'POST',
						body: JSON.stringify({
							name: nameField.value.length ? nameField.value : undefined
						}),
						headers: {
							'Content-Type': 'application/json'
						}
					}).then(async (res) => {
						const { lobby } = await res.json();
						window.location = `/game?code=${lobby.code}&username=${usernameField.value}`;
					});
				});

			const codeField = document.getElementById('code-field');
			document.getElementById('join-button').addEventListener('click', (e) => {
				if (!usernameField.value.length || !codeField.value.length) return;
				window.location = `/game?code=${codeField.value}&username=${usernameField.value}`;
			});
		</script>
	</body>
</html>
