<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<title>Lobbies â€¢ 3D Pong</title>
		<script>
			window.addEventListener('DOMContentLoaded', () => {
				const css = `
					*{ box-sizing:border-box; }
					body{
						margin:24px auto;
						max-width:980px;
						padding:24px;
						font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
						color: rgba(255,255,255,.92);
						background: linear-gradient(180deg,#0b1020,#0a1226);
					}
					input{
						width:100%;
						padding:12px;
						border-radius:12px;
						border:1px solid rgba(255,255,255,.18);
						background: rgba(0,0,0,.25);
						color: rgba(255,255,255,.92);
						outline:none;
						margin:0 0 16px 0;
						transition: border .15s, box-shadow .15s;
						display:block;
					}
					input::placeholder{ color: rgba(255,255,255,.45); }
						input:focus{
						border-color: rgba(255,255,255,.22);
						box-shadow: 0 0 0 4px rgba(0,229,255,.12);
					}
					button{
						width:100%;
						padding:14px 16px;
						border-radius:12px;
						border:1px solid rgba(0,0,0,.12);
						background:#fff;
						color:#0b1020;
						font-weight:700;
						cursor:pointer;
						box-shadow:0 6px 16px rgba(0,0,0,.18);
						margin:0 0 18px 0;
						transition: transform .08s, background .15s;
						display:block;
					}
					button:hover{ background: rgba(255,255,255,.92); }
					button:active{ transform: translateY(1px); }

					h1{ font-size: 44px; margin: 0 0 18px 0; }
					h2{ margin-top: 32px; }
				`;
				const style = document.createElement('style');
				style.textContent = css;
				document.head.appendChild(style);

				const h1 = document.querySelector('h1');
				const openH2 = Array.from(document.querySelectorAll('h2')).find(h => h.textContent.trim().toLowerCase() === 'open lobbies');
				if (!h1 || !openH2) return;

				const wrap = document.createElement('div');
				const left = document.createElement('div');
				const right = document.createElement('div');

				const cardStyle = `
					background: rgba(255,255,255,.06);
					border: 1px solid rgba(255,255,255,.10);
					border-radius: 18px;
					box-shadow: 0 12px 40px rgba(0,0,0,.35);
					padding: 20px;
					margin-bottom: 18px;
				`;
				left.style.cssText = cardStyle;
				right.style.cssText = cardStyle;

				const moveRange = (start, stopExclusive, target) => {
					let cur = start;
					while (cur && cur !== stopExclusive) {
						const next = cur.nextElementSibling;
						target.appendChild(cur);
						cur = next;
					}
				};

				moveRange(h1, openH2, left);
				moveRange(openH2, null, right);

				wrap.append(left, right);
				document.body.prepend(wrap);
			});
		</script>
	</head>
	<body>
		<h1>Lobbies</h1>

		<input
			id="username-field"
			placeholder="Username"
			style="margin-bottom: 0.5rem"
		/>

		<div>
			<input id="name-field" placeholder="Lobby name" />
			<button id="create-button">Create Lobby</button>
		</div>

		<div>
			<input id="code-field" placeholder="Join Code" />
			<button id="join-button">Join</button>
		</div>

		<h2 style="margin-top:1rem">Open Lobbies</h2>
		<div id="lobbies-list">
			<% if (lobbies && lobbies.length > 0) { %>
				<% for (let i = 0; i < lobbies.length; i++) { %>
				<div class="lobby">
					<div><strong><%= lobbies[i].name || 'Unnamed Lobby' %></strong></div>
					<div>Join Code: <code><%= lobbies[i].code %></code></div>
					<div>Players: <%= lobbies[i].memberCount %></div>

					<button onclick="join('<%= lobbies[i].code %>')">Join</button>
				</div>
				<% } %>
			<% } else { %>
				<p class="no-lobbies">No open lobbies currently.</p>
			<% } %>
		</div>

		<script>
			const usernameField = document.getElementById('username-field');
			const nameField = document.getElementById('name-field');
			document
				.getElementById('create-button')
				.addEventListener('click', (e) => {
					if (!usernameField.value.length) return;

					fetch('/api/lobbies', {
						method: 'POST',
						body: JSON.stringify({
							name: nameField.value.length ? nameField.value : undefined
						}),
						headers: {
							'Content-Type': 'application/json'
						}
					}).then(async (res) => {
						const { lobby } = await res.json();
						window.location = `/game?code=${lobby.code}&username=${usernameField.value}`;
					});
				});

			const codeField = document.getElementById('code-field');
			document.getElementById('join-button').addEventListener('click', (e) => {
				if (!usernameField.value.length || !codeField.value.length) return;
				window.location = `/game?code=${codeField.value}&username=${usernameField.value}`;
			});

			function join(code) {
				if (!usernameField.value.length) return;
				window.location = `/game?code=${code}&username=${usernameField.value}`;
			}
		</script>
	</body>
</html>
